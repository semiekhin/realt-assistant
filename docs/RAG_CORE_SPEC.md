# ТЗ: RAG-ядро для Realt Assistant

**Версия:** 1.0  
**Дата:** 08.01.2026  
**Статус:** Утверждено

---

## Философия

Бот = персональный Claude для риэлтора. Загрузил документы — общайся естественно. LLM сам понимает, сам решает, сам делает.

---

## Пользовательский сценарий
```
Риэлтор: [загружает документы по ЖК]
Бот: Принял. Спрашивай что угодно.

Риэлтор: сколько до моря?
Бот: 350 метров, первая береговая линия, собственный пляж.

Риэлтор: что есть до 25 млн?
Бот: Студия 24м², 7 этаж — 21.17 млн.

Риэлтор: сделай кп
Бот: На студию 24м²? 
Риэлтор: да
Бот: [PDF]

Риэлтор: а если взять в рассрочку?
Бот: ПВ 50% = 10.58 млн, потом 882к/мес 12 месяцев. Без удорожания.

Риэлтор: чем лучше конкурентов?
Бот: Единственный с собственным пляжом, дендропарком 7 га, 
     медцентром и SPA 3000м². Цена за м² — 850к, у конкурентов 950к-2.7м.
```

---

## Архитектура
```
┌─────────────────────────────────────────┐
│            Telegram Bot                  │
│         Любое сообщение                  │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│         RAG Search (ChromaDB)            │
│     Находит релевантные данные          │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│             LLM (GPT-4o)                 │
│  Понимает → Решает → Делает              │
│  - Ответ текстом                         │
│  - Генерация HTML → PDF                  │
│  - Расчёт (вызов функции)               │
│  - Уточняющий вопрос                    │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│           Response Handler               │
│  text → send_message                     │
│  html → convert to PDF → send_document  │
│  calc → execute → format → send         │
└─────────────────────────────────────────┘
```

---

## Генерация документов (КП/PDF)

LLM полностью контролирует структуру и дизайн:
```
Данные из RAG → LLM → HTML с инлайн-стилями → wkhtmltopdf → PDF
```

Никаких фиксированных шаблонов и стилей. LLM сам решает:
- Какие блоки включить
- В каком порядке
- Какие акценты расставить
- Какой визуальный стиль

---

## Промпт для LLM
```
Ты — умный ассистент риэлтора. Отвечаешь как опытный коллега.

Данные из документов:
---
{chunks из RAG}
---

История диалога:
{последние сообщения}

Запрос: {текст пользователя}

Что можешь делать:
1. Ответить текстом — просто отвечай
2. Сгенерировать документ — верни:
   {"action": "document", "html": "<полный HTML>", "filename": "name.pdf"}
3. Посчитать — верни:
   {"action": "calc", "type": "installment|mortgage|roi", "params": {...}}
4. Отправить файл — верни:
   {"action": "file", "name": "название файла"}
5. Уточнить — просто спроси

Правила:
- Данных нет — скажи честно
- Нужно уточнить — спроси коротко
- Документы делай красивые, продающие, профессиональные
- HTML должен быть автономный (inline CSS)
```

---

## Компоненты

### 1. RAG Engine (ChromaDB)
```python
class RAGEngine:
    def add_document(self, user_id, property_id, file_name, chunks):
        """Добавить чанки документа в базу"""
        
    def search(self, user_id, query, property_id=None, limit=10):
        """Найти релевантные чанки"""
```

### 2. Document Processor

- Парсинг через Vision API (есть)
- Разбивка на чанки
- Генерация эмбеддингов (text-embedding-3-small)
- Сохранение в ChromaDB

### 3. Universal Handler
```python
async def handle_message(chat_id, text):
    chunks = rag.search(user_id=chat_id, query=text)
    history = get_chat_history(chat_id)
    response = await llm_respond(chunks, history, text)
    await execute_response(chat_id, response)
```

### 4. Калькуляторы

Остаются как функции, LLM вызывает когда нужно:
- calc_installment(price, pv, months)
- calc_mortgage(price, pv, years, program)  
- calc_roi(price, rent, occupancy)

---

## Данные

### SQLite (навигация)
```sql
users: id, telegram_id, created_at
properties: id, user_id, name, created_at
property_files: id, property_id, file_name, file_path
chat_history: id, user_id, role, content, created_at
```

### ChromaDB (знания)
```
Collection: user_{telegram_id}
- documents: текст чанков
- metadatas: {property_id, property_name, file_name, page}
- embeddings: векторы
```

---

## Этапы реализации

### Этап 1: RAG ядро
- [ ] Установка ChromaDB
- [ ] Chunking при загрузке файлов
- [ ] Эмбеддинги (text-embedding-3-small)
- [ ] Поиск по запросу

### Этап 2: Универсальный handler
- [ ] Любое сообщение → RAG → LLM → ответ
- [ ] История диалога для контекста
- [ ] Убираем FSM

### Этап 3: Генерация документов
- [ ] LLM → HTML → PDF
- [ ] Убираем фиксированные стили
- [ ] wkhtmltopdf или weasyprint

### Этап 4: Действия
- [ ] Калькуляторы как функции LLM
- [ ] Отправка файлов по запросу

### Этап 5 (будущее): Помощник переписки
- [ ] Анализ пересланных сообщений
- [ ] Генерация вариантов ответа клиенту
- [ ] Контекст объектов для аргументации

---

## Что убираем

- FSM состояния
- Фиксированные меню и кнопки
- 6 стилей PDF (pdf_styles.py)
- content_composer.py
- kp_generator_v2.py
- Жёсткие handlers

## Что остаётся

- parser_v2.py (Vision парсинг)
- calculators.py (функции расчёта)
- telegram.py (API)
- Базовая навигация (список ЖК)

---

## Результат

Риэлтор общается с ботом как с Claude.ai:
- Загрузил документы — спрашивает что угодно
- Бот понимает контекст и историю
- Генерирует документы адаптивно
- Считает когда нужно
- Уточняет если не понял
